# =============================================================================
# SECRETS MANAGEMENT CONFIGURATION
# =============================================================================
#
# âš ï¸  PRODUCTION CHECKLIST - BEFORE DEPLOYING TO PRODUCTION:
#
# 1. VAULT CONFIGURATION (line ~21)
#    - Replace "https://vault.example.com:8200" with your actual Vault server
#    - Update the Kubernetes auth role name
#
# 2. SEALED SECRETS (line ~131)
#    - Generate real sealed secrets using kubeseal:
#      kubectl create secret generic minecraft-api-secrets \
#        --from-literal=jwt-secret=$(openssl rand -base64 32) \
#        --from-literal=encryption-key=$(openssl rand -base64 32) \
#        --dry-run=client -o yaml | kubeseal --format yaml
#    - Replace REPLACE_WITH_SEALED_SECRET placeholders
#
# 3. ENCRYPTION AT REST (line ~211)
#    - Generate a new encryption key:
#      head -c 32 /dev/urandom | base64
#    - Replace the placeholder "c2VjcmV0IGlzIHNlY3VyZQ==" values
#    - Configure kube-apiserver with --encryption-provider-config
#
# 4. CERT-MANAGER (line ~148)
#    - Update email address for Let's Encrypt notifications
#    - Update DNS names to match your actual domains
#
# 5. EXTERNAL SECRETS
#    - Configure your actual secret paths in Vault/AWS/GCP
#    - Update the SecretStore provider configuration
#
# =============================================================================

apiVersion: v1
kind: Secret
metadata:
  name: external-secrets-config
  namespace: minecraft-platform
type: Opaque
data:
  # Base64 encoded configuration for external secret providers
  # TODO: Replace with actual Vault configuration before production
  vault-config: |
    YWRkcjogaHR0cHM6Ly92YXVsdC5leGFtcGxlLmNvbTo4MjAwCmF1dGg6CiAgbWV0aG9kOiBrdWJlcm5ldGVzCiAgcm9sZTogbWluZWNyYWZ0LXBsYXRmb3JtCiAgcGF0aDogYXV0aC9rdWJlcm5ldGVz

---
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: vault-backend
  namespace: minecraft-platform
spec:
  provider:
    vault:
      server: "https://vault.example.com:8200"
      path: "secret"
      version: "v2"
      auth:
        kubernetes:
          mountPath: "auth/kubernetes"
          role: "minecraft-platform"
          serviceAccountRef:
            name: "external-secrets-sa"

---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: database-credentials
  namespace: minecraft-platform
spec:
  refreshInterval: 15m
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  target:
    name: database-credentials
    creationPolicy: Owner
  data:
  - secretKey: username
    remoteRef:
      key: database/minecraft-platform
      property: username
  - secretKey: password
    remoteRef:
      key: database/minecraft-platform
      property: password
  - secretKey: connection-string
    remoteRef:
      key: database/minecraft-platform
      property: connection_string

---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: api-tls-certificates
  namespace: minecraft-platform
spec:
  refreshInterval: 24h
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  target:
    name: api-tls-certificates
    creationPolicy: Owner
    template:
      type: kubernetes.io/tls
  data:
  - secretKey: tls.crt
    remoteRef:
      key: certificates/api-server
      property: certificate
  - secretKey: tls.key
    remoteRef:
      key: certificates/api-server
      property: private_key

---
# Service Account for External Secrets Operator
apiVersion: v1
kind: ServiceAccount
metadata:
  name: external-secrets-sa
  namespace: minecraft-platform
  annotations:
    vault.hashicorp.com/role: "minecraft-platform"

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: external-secrets-reader
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list", "watch", "create", "update", "patch"]
- apiGroups: ["external-secrets.io"]
  resources: ["externalsecrets", "secretstores"]
  verbs: ["get", "list", "watch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: external-secrets-reader
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: external-secrets-reader
subjects:
- kind: ServiceAccount
  name: external-secrets-sa
  namespace: minecraft-platform

---
# Sealed Secrets for GitOps workflow
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: minecraft-api-secrets
  namespace: minecraft-platform
spec:
  encryptedData:
    jwt-secret: REPLACE_WITH_SEALED_SECRET
    encryption-key: REPLACE_WITH_SEALED_SECRET
  template:
    metadata:
      name: minecraft-api-secrets
      namespace: minecraft-platform
    type: Opaque

---
# Certificate management with cert-manager
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: security@minecraft-platform.com
    privateKeySecretRef:
      name: letsencrypt-prod
    solvers:
    - http01:
        ingress:
          class: nginx
      selector:
        dnsNames:
        - api.minecraft-platform.com
        - dashboard.minecraft-platform.com

---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: api-server-tls
  namespace: minecraft-platform
spec:
  secretName: api-server-tls
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
  dnsNames:
  - api.minecraft-platform.com
  - minecraft-platform.com

---
# Secret rotation policy
apiVersion: v1
kind: ConfigMap
metadata:
  name: secret-rotation-policy
  namespace: minecraft-platform
data:
  policy.yaml: |
    rotation_policies:
      - name: "database-credentials"
        interval: "30d"
        pre_rotation_hook: "kubectl scale deployment api-server --replicas=0"
        post_rotation_hook: "kubectl scale deployment api-server --replicas=3"

      - name: "jwt-secrets"
        interval: "90d"
        graceful_rotation: true

      - name: "tls-certificates"
        interval: "85d"
        auto_renewal: true

---
# Kubernetes secrets encryption at rest
apiVersion: v1
kind: EncryptionConfiguration
metadata:
  name: encryption-config
resources:
- resources:
  - secrets
  providers:
  - aescbc:
      keys:
      - name: key1
        secret: c2VjcmV0IGlzIHNlY3VyZQ==
  - identity: {}
- resources:
  - configmaps
  providers:
  - aescbc:
      keys:
      - name: key1
        secret: c2VjcmV0IGlzIHNlY3VyZQ==
  - identity: {}

---
# Secret scanner for vulnerability detection
apiVersion: batch/v1
kind: CronJob
metadata:
  name: secret-scanner
  namespace: minecraft-platform
spec:
  schedule: "0 2 * * *"  # Daily at 2 AM
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: secret-scanner
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
          containers:
          - name: scanner
            image: trufflesecurity/trufflehog:3.63.0
            imagePullPolicy: Always
            command:
            - /bin/sh
            - -c
            - |
              trufflehog kubernetes \
                --namespace minecraft-platform \
                --only-verified \
                --json > /tmp/scan-results.json

              if [ -s /tmp/scan-results.json ]; then
                echo "Security vulnerabilities detected!"
                curl -X POST "${SLACK_WEBHOOK_URL}" \
                  -H 'Content-type: application/json' \
                  --data '{"text":"ðŸš¨ Secret scanner found vulnerabilities in minecraft-platform namespace"}'
              fi
            env:
            - name: SLACK_WEBHOOK_URL
              valueFrom:
                secretKeyRef:
                  name: notification-secrets
                  key: slack-webhook
            resources:
              requests:
                cpu: 100m
                memory: 256Mi
              limits:
                cpu: 500m
                memory: 1Gi
          restartPolicy: OnFailure

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: secret-scanner
  namespace: minecraft-platform

---
# Secret scanner needs read-only access to secrets to detect credential leaks
# checkov:skip=CKV_K8S_156: Secret scanner security tool requires secret read access for vulnerability detection
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: secret-scanner
  namespace: minecraft-platform
  annotations:
    checkov.io/skip1: CKV_K8S_156=Security scanner requires read-only secret access for vulnerability detection
rules:
- apiGroups: [""]
  resources: ["secrets", "configmaps"]
  verbs: ["get", "list"]

---
# checkov:skip=CKV_K8S_157: RoleBinding grants read-only access for security scanning
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: secret-scanner
  namespace: minecraft-platform
  annotations:
    checkov.io/skip1: CKV_K8S_157=RoleBinding for security scanner with read-only access
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: secret-scanner
subjects:
- kind: ServiceAccount
  name: secret-scanner
  namespace: minecraft-platform