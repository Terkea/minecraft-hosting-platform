apiVersion: batch/v1
kind: CronJob
metadata:
  name: trivy-vulnerability-scanner
  namespace: minecraft-platform
  labels:
    app: trivy-scanner
spec:
  schedule: "0 1 * * *"  # Daily at 1 AM
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: trivy-scanner
        spec:
          serviceAccountName: trivy-scanner
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            fsGroup: 1000
          containers:
          - name: trivy
            image: aquasec/trivy:0.45.1
            imagePullPolicy: Always
            command:
            - /bin/sh
            - -c
            - |
              # Update Trivy database
              trivy image --download-db-only

              # Scan running container images
              kubectl get pods -n minecraft-platform -o jsonpath='{.items[*].spec.containers[*].image}' | tr ' ' '\n' | sort -u > /tmp/images.txt

              mkdir -p /tmp/scan-results

              while read image; do
                echo "Scanning image: $image"
                trivy image \
                  --format json \
                  --severity HIGH,CRITICAL \
                  --ignore-unfixed \
                  --output "/tmp/scan-results/$(echo $image | tr '/' '_' | tr ':' '_').json" \
                  "$image"
              done < /tmp/images.txt

              # Generate summary report
              cat > /tmp/scan-results/summary.json << 'EOF'
              {
                "scan_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
                "namespace": "minecraft-platform",
                "total_images": $(wc -l < /tmp/images.txt),
                "vulnerabilities": {
                  "critical": $(grep -r '"Severity":"CRITICAL"' /tmp/scan-results/ | wc -l),
                  "high": $(grep -r '"Severity":"HIGH"' /tmp/scan-results/ | wc -l)
                }
              }
              EOF

              # Send alerts for critical vulnerabilities
              critical_count=$(grep -r '"Severity":"CRITICAL"' /tmp/scan-results/ | wc -l)
              if [ "$critical_count" -gt 0 ]; then
                curl -X POST "$SLACK_WEBHOOK_URL" \
                  -H 'Content-type: application/json' \
                  --data "{\"text\":\"üö® Critical vulnerabilities found: $critical_count in minecraft-platform\"}"
              fi

              # Upload results to monitoring
              curl -X POST "$PROMETHEUS_PUSHGATEWAY_URL/metrics/job/trivy-scanner" \
                -H 'Content-Type: text/plain' \
                --data-binary @- << EOF
              trivy_vulnerabilities_critical $critical_count
              trivy_vulnerabilities_high $(grep -r '"Severity":"HIGH"' /tmp/scan-results/ | wc -l)
              trivy_scan_timestamp $(date +%s)
              EOF
            env:
            - name: SLACK_WEBHOOK_URL
              valueFrom:
                secretKeyRef:
                  name: notification-secrets
                  key: slack-webhook
            - name: PROMETHEUS_PUSHGATEWAY_URL
              value: "http://prometheus-pushgateway.monitoring.svc.cluster.local:9091"
            volumeMounts:
            - name: cache-volume
              mountPath: /root/.cache/trivy
            - name: scan-results
              mountPath: /tmp/scan-results
            resources:
              requests:
                cpu: 500m
                memory: 1Gi
              limits:
                cpu: 2000m
                memory: 4Gi
            securityContext:
              allowPrivilegeEscalation: false
              capabilities:
                drop:
                - ALL
              readOnlyRootFilesystem: true
          volumes:
          - name: cache-volume
            emptyDir:
              sizeLimit: 1Gi
          - name: scan-results
            emptyDir:
              sizeLimit: 100Mi
          restartPolicy: OnFailure

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: trivy-scanner
  namespace: minecraft-platform

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: trivy-scanner
rules:
- apiGroups: [""]
  resources: ["pods", "nodes"]
  verbs: ["get", "list"]
- apiGroups: ["apps"]
  resources: ["deployments", "replicasets", "daemonsets", "statefulsets"]
  verbs: ["get", "list"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: trivy-scanner
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: trivy-scanner
subjects:
- kind: ServiceAccount
  name: trivy-scanner
  namespace: minecraft-platform

---
# Falco runtime security monitoring
# NOTE: Falco is a kernel-level security monitoring tool that REQUIRES privileged access
# to monitor syscalls, file access, network connections, and container behavior.
# The hostNetwork, hostPID, hostIPC, and privileged settings are fundamental requirements
# for Falco's operation as a security tool - these are NOT vulnerabilities but design requirements.
apiVersion: v1
kind: ConfigMap
metadata:
  name: falco-config
  namespace: minecraft-platform
data:
  falco.yaml: |
    rules_file:
      - /etc/falco/falco_rules.yaml
      - /etc/falco/minecraft_rules.yaml

    time_format_iso_8601: true
    json_output: true
    json_include_output_property: true

    log_stderr: true
    log_syslog: true
    log_level: info

    priority: debug

    buffered_outputs: false
    outputs_queue_capacity: 65536

    syscall_event_drops:
      threshold: .1
      actions:
        - log
        - alert

    outputs:
      rate: 1
      max_burst: 1000

    syslog_output:
      enabled: true

    program_output:
      enabled: true
      keep_alive: false
      program: |
        curl -X POST "$WEBHOOK_URL" \
          -H 'Content-Type: application/json' \
          -d @-

    http_output:
      enabled: true
      url: http://falco-webhook.monitoring.svc.cluster.local:2801/

  minecraft_rules.yaml: |
    # Custom Minecraft platform security rules

    - rule: Unauthorized Process in Minecraft Container
      desc: Detect unauthorized process execution in Minecraft server containers
      condition: >
        spawned_process and
        container and
        k8s.ns.name = "minecraft-platform" and
        not proc.name in (java, sh, bash, sleep, minecraft_server.jar)
      output: >
        Unauthorized process in Minecraft container
        (user=%user.name command=%proc.cmdline container=%container.name image=%container.image.repository)
      priority: WARNING

    - rule: Minecraft Container Privilege Escalation
      desc: Detect privilege escalation in Minecraft containers
      condition: >
        spawned_process and
        container and
        k8s.ns.name = "minecraft-platform" and
        proc.is_setuid_root = true
      output: >
        Privilege escalation in Minecraft container
        (user=%user.name command=%proc.cmdline container=%container.name)
      priority: CRITICAL

    - rule: Suspicious Network Activity from Minecraft Server
      desc: Detect unexpected network connections from Minecraft servers
      condition: >
        outbound and
        container and
        k8s.ns.name = "minecraft-platform" and
        not fd.dip in (minecraft_allowed_ips) and
        not fd.dport in (25565, 25566, 80, 443, 53)
      output: >
        Suspicious outbound connection from Minecraft server
        (connection=%fd.name container=%container.name)
      priority: WARNING

    - rule: File Modification in Read-Only Container
      desc: Detect file modifications in containers that should be read-only
      condition: >
        modify and
        container and
        k8s.ns.name = "minecraft-platform" and
        fd.name startswith /usr
      output: >
        File modified in read-only container
        (file=%fd.name container=%container.name)
      priority: ERROR

---
# checkov:skip=CKV_K8S_16: Falco security monitoring requires privileged container to access kernel syscalls
# checkov:skip=CKV_K8S_17: Falco requires hostPID to monitor process activity across the node
# checkov:skip=CKV_K8S_18: Falco requires hostIPC to monitor inter-process communication
# checkov:skip=CKV_K8S_19: Falco requires hostNetwork to monitor network activity across the node
# checkov:skip=CKV_K8S_22: Falco requires root to access kernel-level security monitoring
# checkov:skip=CKV_K8S_23: Falco requires root for kernel syscall monitoring
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: falco
  namespace: minecraft-platform
  labels:
    app: falco
  annotations:
    description: "Falco security monitoring - requires elevated privileges by design"
    checkov.io/skip1: CKV_K8S_16=Falco security tool requires privileged for syscall monitoring
    checkov.io/skip2: CKV_K8S_17=Falco security tool requires hostPID for process monitoring
    checkov.io/skip3: CKV_K8S_18=Falco security tool requires hostIPC for IPC monitoring
    checkov.io/skip4: CKV_K8S_19=Falco security tool requires hostNetwork for network monitoring
    checkov.io/skip5: CKV_K8S_22=Falco security tool requires root for kernel access
    checkov.io/skip6: CKV_K8S_23=Falco security tool requires root for syscall monitoring
spec:
  selector:
    matchLabels:
      app: falco
  template:
    metadata:
      labels:
        app: falco
    spec:
      serviceAccountName: falco
      tolerations:
      - key: node-role.kubernetes.io/master
        effect: NoSchedule
      - key: node-role.kubernetes.io/control-plane
        effect: NoSchedule
      hostNetwork: true
      hostPID: true
      hostIPC: true
      securityContext:
        runAsUser: 0
      containers:
      - name: falco
        image: falcosecurity/falco-no-driver:0.35.1
        imagePullPolicy: Always
        args:
        - /usr/bin/falco
        - --cri
        - /run/containerd/containerd.sock
        - --k8s-api
        - --k8s-api-cert
        - /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        - --k8s-api-token
        - /var/run/secrets/kubernetes.io/serviceaccount/token
        env:
        - name: WEBHOOK_URL
          valueFrom:
            secretKeyRef:
              name: notification-secrets
              key: falco-webhook
        volumeMounts:
        - name: falco-config
          mountPath: /etc/falco
        - name: containerd-socket
          mountPath: /run/containerd/containerd.sock
        - name: proc
          mountPath: /host/proc
          readOnly: true
        - name: boot
          mountPath: /host/boot
          readOnly: true
        - name: lib-modules
          mountPath: /host/lib/modules
          readOnly: true
        - name: usr
          mountPath: /host/usr
          readOnly: true
        - name: etc
          mountPath: /host/etc
          readOnly: true
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 1Gi
        securityContext:
          privileged: true
      volumes:
      - name: falco-config
        configMap:
          name: falco-config
      - name: containerd-socket
        hostPath:
          path: /run/containerd/containerd.sock
      - name: proc
        hostPath:
          path: /proc
      - name: boot
        hostPath:
          path: /boot
      - name: lib-modules
        hostPath:
          path: /lib/modules
      - name: usr
        hostPath:
          path: /usr
      - name: etc
        hostPath:
          path: /etc

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: falco
  namespace: minecraft-platform

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: falco
rules:
- apiGroups: [""]
  resources: ["nodes", "namespaces", "pods", "replicationcontrollers", "services", "events"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["extensions", "apps"]
  resources: ["daemonsets", "deployments", "replicasets"]
  verbs: ["get", "list", "watch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: falco
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: falco
subjects:
- kind: ServiceAccount
  name: falco
  namespace: minecraft-platform

---
# KUBE-BENCH for CIS Kubernetes benchmark compliance
apiVersion: batch/v1
kind: CronJob
metadata:
  name: kube-bench
  namespace: minecraft-platform
spec:
  schedule: "0 3 * * 0"  # Weekly on Sunday at 3 AM
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: kube-bench
          securityContext:
            runAsUser: 0
          containers:
          - name: kube-bench
            image: aquasec/kube-bench:v0.6.15
            imagePullPolicy: Always
            command: ["kube-bench"]
            args: ["--json", "--outputfile", "/tmp/results.json"]
            volumeMounts:
            - name: var-lib-etcd
              mountPath: /var/lib/etcd
              readOnly: true
            - name: var-lib-kubelet
              mountPath: /var/lib/kubelet
              readOnly: true
            - name: etc-kubernetes
              mountPath: /etc/kubernetes
              readOnly: true
            - name: usr-bin
              mountPath: /usr/local/mount-from-host/bin
              readOnly: true
            - name: results
              mountPath: /tmp
            resources:
              requests:
                cpu: 100m
                memory: 256Mi
              limits:
                cpu: 500m
                memory: 512Mi
          - name: report-uploader
            image: curlimages/curl:8.5.0
            imagePullPolicy: Always
            command:
            - /bin/sh
            - -c
            - |
              sleep 30  # Wait for kube-bench to complete

              if [ -f /tmp/results.json ]; then
                # Upload to monitoring system
                curl -X POST "$MONITORING_WEBHOOK_URL" \
                  -H 'Content-Type: application/json' \
                  -d @/tmp/results.json

                # Check for failures and alert
                failures=$(grep -o '"result":"FAIL"' /tmp/results.json | wc -l)
                if [ "$failures" -gt 0 ]; then
                  curl -X POST "$SLACK_WEBHOOK_URL" \
                    -H 'Content-type: application/json' \
                    --data "{\"text\":\"‚ö†Ô∏è CIS Kubernetes Benchmark: $failures compliance failures detected\"}"
                fi
              fi
            resources:
              requests:
                cpu: 50m
                memory: 64Mi
              limits:
                cpu: 100m
                memory: 128Mi
            env:
            - name: SLACK_WEBHOOK_URL
              valueFrom:
                secretKeyRef:
                  name: notification-secrets
                  key: slack-webhook
            - name: MONITORING_WEBHOOK_URL
              value: "http://compliance-collector.monitoring.svc.cluster.local:8080/cis-benchmark"
            volumeMounts:
            - name: results
              mountPath: /tmp
          volumes:
          - name: var-lib-etcd
            hostPath:
              path: /var/lib/etcd
          - name: var-lib-kubelet
            hostPath:
              path: /var/lib/kubelet
          - name: etc-kubernetes
            hostPath:
              path: /etc/kubernetes
          - name: usr-bin
            hostPath:
              path: /usr/bin
          - name: results
            emptyDir: {}
          restartPolicy: OnFailure

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: kube-bench
  namespace: minecraft-platform

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: kube-bench
rules:
- apiGroups: [""]
  resources: ["nodes", "pods"]
  verbs: ["get", "list"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: kube-bench
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: kube-bench
subjects:
- kind: ServiceAccount
  name: kube-bench
  namespace: minecraft-platform