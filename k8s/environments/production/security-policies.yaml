# This is an example Pod showing security context constraints - not deployed
# checkov:skip=CKV_K8S_14: Example pod does not specify an image
# checkov:skip=CKV_K8S_20: Example pod does not specify resources
# checkov:skip=CKV_K8S_43: Example pod does not specify an image tag
apiVersion: v1
kind: Pod
metadata:
  name: security-context-constraints
  namespace: minecraft-platform-prod
  annotations:
    description: "Example pod demonstrating security context constraints - not deployed"
    checkov.io/skip1: CKV_K8S_14=Example reference pod, not deployed
    checkov.io/skip2: CKV_K8S_20=Example reference pod, not deployed
    checkov.io/skip3: CKV_K8S_43=Example reference pod, not deployed
spec:
  # Security context for all pods
  securityContext:
    runAsNonRoot: true
    runAsUser: 65534
    runAsGroup: 65534
    fsGroup: 65534
    seccompProfile:
      type: RuntimeDefault

  containers:
  - name: example-container
    securityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      capabilities:
        drop:
        - ALL
      runAsNonRoot: true
      runAsUser: 65534

---
# Pod Security Standards enforcement
apiVersion: v1
kind: Namespace
metadata:
  name: minecraft-platform-prod
  labels:
    pod-security.kubernetes.io/enforce: restricted
    pod-security.kubernetes.io/audit: restricted
    pod-security.kubernetes.io/warn: restricted

---
# Service Account for API server with minimal permissions
apiVersion: v1
kind: ServiceAccount
metadata:
  name: api-server
  namespace: minecraft-platform-prod
  annotations:
    # AWS IAM role for service account (IRSA)
    eks.amazonaws.com/role-arn: "arn:aws:iam::123456789012:role/minecraft-platform-api-server"
automountServiceAccountToken: false

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: operator
  namespace: minecraft-platform-prod
  annotations:
    eks.amazonaws.com/role-arn: "arn:aws:iam::123456789012:role/minecraft-platform-operator"
automountServiceAccountToken: true  # Operator needs to access Kubernetes API

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: frontend
  namespace: minecraft-platform-prod
  annotations:
    eks.amazonaws.com/role-arn: "arn:aws:iam::123456789012:role/minecraft-platform-frontend"
automountServiceAccountToken: false

---
# RBAC for operator
# checkov:skip=CKV_K8S_155: Operator requires secret management permissions to create/update Minecraft server configs
# checkov:skip=CKV_K8S_156: Operator ClusterRole requires broad permissions for server lifecycle management
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: minecraft-platform-operator
  annotations:
    checkov.io/skip1: CKV_K8S_155=Operator needs secret access for Minecraft server configuration management
    checkov.io/skip2: CKV_K8S_156=Operator requires broad permissions for Kubernetes resource management
rules:
# Minecraft server management
- apiGroups: ["minecraft-platform.com"]
  resources: ["minecraftservers", "backupschedules", "pluginconfigs"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

# Core Kubernetes resources for server management
- apiGroups: [""]
  resources: ["pods", "services", "configmaps", "secrets", "persistentvolumeclaims"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

- apiGroups: ["apps"]
  resources: ["deployments", "statefulsets", "replicasets"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

- apiGroups: ["networking.k8s.io"]
  resources: ["ingresses", "networkpolicies"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

# Events and status updates
- apiGroups: [""]
  resources: ["events"]
  verbs: ["create", "patch"]

# Webhook configuration
- apiGroups: ["admissionregistration.k8s.io"]
  resources: ["validatingwebhookconfigurations", "mutatingwebhookconfigurations"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: minecraft-platform-operator
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: minecraft-platform-operator
subjects:
- kind: ServiceAccount
  name: operator
  namespace: minecraft-platform-prod

---
# RBAC for monitoring access
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: minecraft-platform-monitoring
rules:
- apiGroups: [""]
  resources: ["pods", "services", "endpoints", "nodes", "namespaces"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["apps"]
  resources: ["deployments", "statefulsets", "daemonsets", "replicasets"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["networking.k8s.io"]
  resources: ["ingresses"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["minecraft-platform.com"]
  resources: ["minecraftservers"]
  verbs: ["get", "list", "watch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: minecraft-platform-monitoring
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: minecraft-platform-monitoring
subjects:
- kind: ServiceAccount
  name: prometheus
  namespace: monitoring

---
# Network security policies for external access
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: external-ingress-policy
  namespace: minecraft-platform-prod
spec:
  podSelector:
    matchLabels:
      network-policy: allow-external
  policyTypes:
  - Ingress
  ingress:
  - from: []  # Allow from anywhere
    ports:
    - protocol: TCP
      port: 80
    - protocol: TCP
      port: 443

---
# ⚠️ PRODUCTION: Secret encryption configuration
# Generate encryption key: head -c 32 /dev/urandom | base64
# Store in Vault or use SealedSecrets
apiVersion: v1
kind: Secret
metadata:
  name: encryption-config
  namespace: minecraft-platform-prod
  annotations:
    config.kubernetes.io/needs-replacement: "true"
type: Opaque
data:
  # Replace with actual encryption key before production deployment
  encryption-key: REPLACE_WITH_ENCRYPTION_KEY

---
# ⚠️ PRODUCTION: Image pull secrets for private registries
# Generate using:
#   kubectl create secret docker-registry regcred \
#     --docker-server=<registry> \
#     --docker-username=<user> \
#     --docker-password=<token> \
#     --docker-email=<email> \
#     --dry-run=client -o yaml | kubeseal --format yaml
apiVersion: v1
kind: Secret
metadata:
  name: regcred
  namespace: minecraft-platform-prod
  annotations:
    config.kubernetes.io/needs-replacement: "true"
type: kubernetes.io/dockerconfigjson
data:
  .dockerconfigjson: REPLACE_WITH_DOCKER_CONFIG

---
# Admission controller webhook for security validation
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionWebhook
metadata:
  name: minecraft-platform-security-webhook
webhooks:
- name: security.minecraft-platform.com
  clientConfig:
    service:
      name: security-webhook
      namespace: minecraft-platform-prod
      path: "/validate"
  rules:
  - operations: ["CREATE", "UPDATE"]
    apiGroups: [""]
    apiVersions: ["v1"]
    resources: ["pods"]
  - operations: ["CREATE", "UPDATE"]
    apiGroups: ["minecraft-platform.com"]
    apiVersions: ["v1"]
    resources: ["minecraftservers"]
  admissionReviewVersions: ["v1", "v1beta1"]
  sideEffects: None
  failurePolicy: Fail

---
# OPA Gatekeeper constraints for security enforcement
apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: k8srequiredsecuritycontext
spec:
  crd:
    spec:
      names:
        kind: K8sRequiredSecurityContext
      validation:
        type: object
        properties:
          runAsNonRoot:
            type: boolean
          readOnlyRootFilesystem:
            type: boolean
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8srequiredsecuritycontext

        violation[{"msg": msg}] {
          container := input.review.object.spec.containers[_]
          not container.securityContext.runAsNonRoot
          msg := "Container must run as non-root user"
        }

        violation[{"msg": msg}] {
          container := input.review.object.spec.containers[_]
          not container.securityContext.readOnlyRootFilesystem
          msg := "Container must have read-only root filesystem"
        }

---
apiVersion: config.gatekeeper.sh/v1alpha1
kind: K8sRequiredSecurityContext
metadata:
  name: must-have-security-context
spec:
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Pod"]
    excludedNamespaces: ["kube-system", "kube-public", "gatekeeper-system"]
  parameters:
    runAsNonRoot: true
    readOnlyRootFilesystem: true

---
# Falco rules for runtime security monitoring
apiVersion: v1
kind: ConfigMap
metadata:
  name: falco-rules
  namespace: minecraft-platform-prod
data:
  minecraft_rules.yaml: |
    - rule: Minecraft Server Suspicious Activity
      desc: Detect suspicious activity in Minecraft server containers
      condition: >
        container and
        k8s.ns.name = "minecraft-platform-prod" and
        k8s.pod.label["minecraft-platform.com/server"] = "true" and
        (spawned_process or
         write_below_etc or
         write_below_root_etc or
         read_sensitive_file or
         network_connection_outside_cluster)
      output: >
        Suspicious activity in Minecraft server
        (user=%user.name command=%proc.cmdline container=%container.name
         pod=%k8s.pod.name namespace=%k8s.ns.name)
      priority: WARNING
      tags: [minecraft, security, runtime]

    - rule: Minecraft Platform API Anomaly
      desc: Detect anomalous API server behavior
      condition: >
        container and
        k8s.ns.name = "minecraft-platform-prod" and
        k8s.pod.label["app.kubernetes.io/name"] = "api-server" and
        (outbound_connection_to_unauthorized_server or
         unexpected_network_traffic or
         suspicious_file_access)
      output: >
        Anomalous API server behavior detected
        (command=%proc.cmdline container=%container.name
         pod=%k8s.pod.name namespace=%k8s.ns.name)
      priority: CRITICAL
      tags: [api, security, anomaly]