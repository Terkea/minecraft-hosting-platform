apiVersion: v1
kind: Pod
metadata:
  name: security-context-constraints
  namespace: minecraft-platform-prod
spec:
  # Security context for all pods
  securityContext:
    runAsNonRoot: true
    runAsUser: 65534
    runAsGroup: 65534
    fsGroup: 65534
    seccompProfile:
      type: RuntimeDefault

  containers:
  - name: example-container
    securityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      capabilities:
        drop:
        - ALL
      runAsNonRoot: true
      runAsUser: 65534

---
# Pod Security Standards enforcement
apiVersion: v1
kind: Namespace
metadata:
  name: minecraft-platform-prod
  labels:
    pod-security.kubernetes.io/enforce: restricted
    pod-security.kubernetes.io/audit: restricted
    pod-security.kubernetes.io/warn: restricted

---
# Service Account for API server with minimal permissions
apiVersion: v1
kind: ServiceAccount
metadata:
  name: api-server
  namespace: minecraft-platform-prod
  annotations:
    # AWS IAM role for service account (IRSA)
    eks.amazonaws.com/role-arn: "arn:aws:iam::123456789012:role/minecraft-platform-api-server"
automountServiceAccountToken: false

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: operator
  namespace: minecraft-platform-prod
  annotations:
    eks.amazonaws.com/role-arn: "arn:aws:iam::123456789012:role/minecraft-platform-operator"
automountServiceAccountToken: true  # Operator needs to access Kubernetes API

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: frontend
  namespace: minecraft-platform-prod
  annotations:
    eks.amazonaws.com/role-arn: "arn:aws:iam::123456789012:role/minecraft-platform-frontend"
automountServiceAccountToken: false

---
# RBAC for operator
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: minecraft-platform-operator
rules:
# Minecraft server management
- apiGroups: ["minecraft-platform.com"]
  resources: ["minecraftservers", "backupschedules", "pluginconfigs"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

# Core Kubernetes resources for server management
- apiGroups: [""]
  resources: ["pods", "services", "configmaps", "secrets", "persistentvolumeclaims"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

- apiGroups: ["apps"]
  resources: ["deployments", "statefulsets", "replicasets"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

- apiGroups: ["networking.k8s.io"]
  resources: ["ingresses", "networkpolicies"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

# Events and status updates
- apiGroups: [""]
  resources: ["events"]
  verbs: ["create", "patch"]

# Webhook configuration
- apiGroups: ["admissionregistration.k8s.io"]
  resources: ["validatingwebhookconfigurations", "mutatingwebhookconfigurations"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: minecraft-platform-operator
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: minecraft-platform-operator
subjects:
- kind: ServiceAccount
  name: operator
  namespace: minecraft-platform-prod

---
# RBAC for monitoring access
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: minecraft-platform-monitoring
rules:
- apiGroups: [""]
  resources: ["pods", "services", "endpoints", "nodes", "namespaces"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["apps"]
  resources: ["deployments", "statefulsets", "daemonsets", "replicasets"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["networking.k8s.io"]
  resources: ["ingresses"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["minecraft-platform.com"]
  resources: ["minecraftservers"]
  verbs: ["get", "list", "watch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: minecraft-platform-monitoring
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: minecraft-platform-monitoring
subjects:
- kind: ServiceAccount
  name: prometheus
  namespace: monitoring

---
# Network security policies for external access
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: external-ingress-policy
  namespace: minecraft-platform-prod
spec:
  podSelector:
    matchLabels:
      network-policy: allow-external
  policyTypes:
  - Ingress
  ingress:
  - from: []  # Allow from anywhere
    ports:
    - protocol: TCP
      port: 80
    - protocol: TCP
      port: 443

---
# Secret encryption configuration
apiVersion: v1
kind: Secret
metadata:
  name: encryption-config
  namespace: minecraft-platform-prod
type: Opaque
data:
  # This would contain the encryption key for etcd encryption at rest
  encryption-key: LS0tLS1CRUdJTi...  # Base64 encoded encryption key

---
# Image pull secrets for private registries
apiVersion: v1
kind: Secret
metadata:
  name: regcred
  namespace: minecraft-platform-prod
type: kubernetes.io/dockerconfigjson
data:
  .dockerconfigjson: eyJhdXRocyI6eyJodHRwczovL2luZGV4LmRvY2tlci5pby92MSI6eyJ1c2VybmFtZSI6IilsdXNlciIsInBhc3N3b3JkIjoicGFzcyIsImVtYWlsIjoidGVzdEBleGFtcGxlLmNvbSIsImF1dGgiOiJkSGtlk25WelpYSTZjR0Z6YzBBPSJ9fX0=

---
# Admission controller webhook for security validation
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionWebhook
metadata:
  name: minecraft-platform-security-webhook
webhooks:
- name: security.minecraft-platform.com
  clientConfig:
    service:
      name: security-webhook
      namespace: minecraft-platform-prod
      path: "/validate"
  rules:
  - operations: ["CREATE", "UPDATE"]
    apiGroups: [""]
    apiVersions: ["v1"]
    resources: ["pods"]
  - operations: ["CREATE", "UPDATE"]
    apiGroups: ["minecraft-platform.com"]
    apiVersions: ["v1"]
    resources: ["minecraftservers"]
  admissionReviewVersions: ["v1", "v1beta1"]
  sideEffects: None
  failurePolicy: Fail

---
# OPA Gatekeeper constraints for security enforcement
apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: k8srequiredsecuritycontext
spec:
  crd:
    spec:
      names:
        kind: K8sRequiredSecurityContext
      validation:
        type: object
        properties:
          runAsNonRoot:
            type: boolean
          readOnlyRootFilesystem:
            type: boolean
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8srequiredsecuritycontext

        violation[{"msg": msg}] {
          container := input.review.object.spec.containers[_]
          not container.securityContext.runAsNonRoot
          msg := "Container must run as non-root user"
        }

        violation[{"msg": msg}] {
          container := input.review.object.spec.containers[_]
          not container.securityContext.readOnlyRootFilesystem
          msg := "Container must have read-only root filesystem"
        }

---
apiVersion: config.gatekeeper.sh/v1alpha1
kind: K8sRequiredSecurityContext
metadata:
  name: must-have-security-context
spec:
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Pod"]
    excludedNamespaces: ["kube-system", "kube-public", "gatekeeper-system"]
  parameters:
    runAsNonRoot: true
    readOnlyRootFilesystem: true

---
# Falco rules for runtime security monitoring
apiVersion: v1
kind: ConfigMap
metadata:
  name: falco-rules
  namespace: minecraft-platform-prod
data:
  minecraft_rules.yaml: |
    - rule: Minecraft Server Suspicious Activity
      desc: Detect suspicious activity in Minecraft server containers
      condition: >
        container and
        k8s.ns.name = "minecraft-platform-prod" and
        k8s.pod.label["minecraft-platform.com/server"] = "true" and
        (spawned_process or
         write_below_etc or
         write_below_root_etc or
         read_sensitive_file or
         network_connection_outside_cluster)
      output: >
        Suspicious activity in Minecraft server
        (user=%user.name command=%proc.cmdline container=%container.name
         pod=%k8s.pod.name namespace=%k8s.ns.name)
      priority: WARNING
      tags: [minecraft, security, runtime]

    - rule: Minecraft Platform API Anomaly
      desc: Detect anomalous API server behavior
      condition: >
        container and
        k8s.ns.name = "minecraft-platform-prod" and
        k8s.pod.label["app.kubernetes.io/name"] = "api-server" and
        (outbound_connection_to_unauthorized_server or
         unexpected_network_traffic or
         suspicious_file_access)
      output: >
        Anomalous API server behavior detected
        (command=%proc.cmdline container=%container.name
         pod=%k8s.pod.name namespace=%k8s.ns.name)
      priority: CRITICAL
      tags: [api, security, anomaly]