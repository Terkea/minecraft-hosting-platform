apiVersion: apps/v1
kind: Deployment
metadata:
  name: cluster-autoscaler
  namespace: kube-system
  labels:
    app: cluster-autoscaler
spec:
  selector:
    matchLabels:
      app: cluster-autoscaler
  replicas: 1
  template:
    metadata:
      labels:
        app: cluster-autoscaler
      annotations:
        prometheus.io/scrape: 'true'
        prometheus.io/port: '8085'
    spec:
      priorityClassName: system-cluster-critical
      securityContext:
        runAsNonRoot: true
        runAsUser: 65534
        fsGroup: 65534
      serviceAccountName: cluster-autoscaler
      containers:
      - image: k8s.gcr.io/autoscaling/cluster-autoscaler:v1.21.3
        name: cluster-autoscaler
        resources:
          limits:
            cpu: 100m
            memory: 600Mi
          requests:
            cpu: 100m
            memory: 600Mi
        command:
        - ./cluster-autoscaler
        - --v=4
        - --stderrthreshold=info
        - --cloud-provider=aws
        - --skip-nodes-with-local-storage=false
        - --expander=least-waste
        - --node-group-auto-discovery=asg:tag=k8s.io/cluster-autoscaler/enabled,k8s.io/cluster-autoscaler/minecraft-platform
        - --balance-similar-node-groups
        - --skip-nodes-with-system-pods=false
        # Scaling parameters
        - --scale-down-enabled=true
        - --scale-down-delay-after-add=10m
        - --scale-down-unneeded-time=10m
        - --scale-down-utilization-threshold=0.5
        - --max-node-provision-time=15m
        # Minecraft-specific optimizations
        - --scale-down-delay-after-delete=10s
        - --scale-down-delay-after-failure=3m
        - --max-empty-bulk-delete=10
        - --max-graceful-termination-sec=600
        env:
        - name: AWS_REGION
          value: us-west-2
        - name: AWS_STS_REGIONAL_ENDPOINTS
          value: regional
        volumeMounts:
        - name: ssl-certs
          mountPath: /etc/ssl/certs/ca-certificates.crt
          readOnly: true
        imagePullPolicy: "Always"
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
      volumes:
      - name: ssl-certs
        hostPath:
          path: "/etc/ssl/certs/ca-bundle.crt"
      nodeSelector:
        node-role.kubernetes.io/control-plane: ""
      tolerations:
      - effect: NoSchedule
        key: node-role.kubernetes.io/control-plane
      - effect: NoSchedule
        key: node-role.kubernetes.io/master

---
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    k8s-addon: cluster-autoscaler.addons.k8s.io
    k8s-app: cluster-autoscaler
  name: cluster-autoscaler
  namespace: kube-system

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cluster-autoscaler
  labels:
    k8s-addon: cluster-autoscaler.addons.k8s.io
    k8s-app: cluster-autoscaler
rules:
  - apiGroups: [""]
    resources: ["events", "endpoints"]
    verbs: ["create", "patch"]
  - apiGroups: [""]
    resources: ["pods/eviction"]
    verbs: ["create"]
  - apiGroups: [""]
    resources: ["pods/status"]
    verbs: ["update"]
  - apiGroups: [""]
    resources: ["endpoints"]
    resourceNames: ["cluster-autoscaler"]
    verbs: ["get", "update"]
  - apiGroups: [""]
    resources: ["nodes"]
    verbs: ["watch", "list", "get", "update"]
  - apiGroups: [""]
    resources:
      - "namespaces"
      - "pods"
      - "services"
      - "replicationcontrollers"
      - "persistentvolumeclaims"
      - "persistentvolumes"
    verbs: ["watch", "list", "get"]
  - apiGroups: ["extensions"]
    resources: ["replicasets", "daemonsets"]
    verbs: ["watch", "list", "get"]
  - apiGroups: ["policy"]
    resources: ["poddisruptionbudgets"]
    verbs: ["watch", "list"]
  - apiGroups: ["apps"]
    resources: ["statefulsets", "replicasets", "daemonsets"]
    verbs: ["watch", "list", "get"]
  - apiGroups: ["storage.k8s.io"]
    resources: ["storageclasses", "csinodes", "csidrivers", "csistoragecapacities"]
    verbs: ["watch", "list", "get"]
  - apiGroups: ["batch", "extensions"]
    resources: ["jobs"]
    verbs: ["get", "list", "watch", "patch"]
  - apiGroups: ["coordination.k8s.io"]
    resources: ["leases"]
    verbs: ["create"]
  - apiGroups: ["coordination.k8s.io"]
    resourceNames: ["cluster-autoscaler"]
    resources: ["leases"]
    verbs: ["get", "update"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: cluster-autoscaler
  namespace: kube-system
  labels:
    k8s-addon: cluster-autoscaler.addons.k8s.io
    k8s-app: cluster-autoscaler
rules:
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["create","list","watch"]
  - apiGroups: [""]
    resources: ["configmaps"]
    resourceNames: ["cluster-autoscaler-status", "cluster-autoscaler-priority-expander"]
    verbs: ["delete", "get", "update", "watch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: cluster-autoscaler
  labels:
    k8s-addon: cluster-autoscaler.addons.k8s.io
    k8s-app: cluster-autoscaler
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-autoscaler
subjects:
  - kind: ServiceAccount
    name: cluster-autoscaler
    namespace: kube-system

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: cluster-autoscaler
  namespace: kube-system
  labels:
    k8s-addon: cluster-autoscaler.addons.k8s.io
    k8s-app: cluster-autoscaler
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: cluster-autoscaler
subjects:
  - kind: ServiceAccount
    name: cluster-autoscaler
    namespace: kube-system

---
# Node pool configuration for different workload types
apiVersion: v1
kind: ConfigMap
metadata:
  name: cluster-autoscaler-nodepool-config
  namespace: kube-system
data:
  nodepool-config.yaml: |
    # Node pool configuration for Minecraft platform
    nodePools:
      # General purpose nodes for API, frontend, operators
      general:
        instanceType: "m5.large"
        minSize: 3
        maxSize: 20
        desiredCapacity: 5
        spotInstances: false
        labels:
          workload-type: "general"
          node-pool: "general"
        taints: []

      # Compute-optimized nodes for Minecraft servers
      minecraft-servers:
        instanceType: "c5.xlarge"
        minSize: 1
        maxSize: 50
        desiredCapacity: 3
        spotInstances: true  # Use spot instances for cost optimization
        spotMaxPrice: "0.10"
        labels:
          workload-type: "minecraft-servers"
          node-pool: "minecraft-servers"
        taints:
        - key: "minecraft-server"
          value: "true"
          effect: "NoSchedule"

      # Memory-optimized nodes for database and caching
      database:
        instanceType: "r5.xlarge"
        minSize: 2
        maxSize: 10
        desiredCapacity: 3
        spotInstances: false  # Database needs stable nodes
        labels:
          workload-type: "database"
          node-pool: "database"
        taints:
        - key: "database"
          value: "true"
          effect: "NoSchedule"

      # GPU nodes for advanced server features (mods, plugins)
      gpu:
        instanceType: "p3.2xlarge"
        minSize: 0
        maxSize: 5
        desiredCapacity: 0
        spotInstances: true
        spotMaxPrice: "1.00"
        labels:
          workload-type: "gpu"
          node-pool: "gpu"
          nvidia.com/gpu: "true"
        taints:
        - key: "nvidia.com/gpu"
          value: "true"
          effect: "NoSchedule"

    # Scaling policies per node pool
    scalingPolicies:
      general:
        scaleUpCooldown: "3m"
        scaleDownCooldown: "10m"
        utilizationThreshold: 0.7

      minecraft-servers:
        scaleUpCooldown: "2m"    # Fast scale-up for game servers
        scaleDownCooldown: "15m" # Slower scale-down to avoid disruption
        utilizationThreshold: 0.6

      database:
        scaleUpCooldown: "5m"
        scaleDownCooldown: "30m" # Very conservative scaling for database
        utilizationThreshold: 0.8

      gpu:
        scaleUpCooldown: "5m"
        scaleDownCooldown: "20m"
        utilizationThreshold: 0.5

---
# Priority Expander configuration for intelligent node selection
apiVersion: v1
kind: ConfigMap
metadata:
  name: cluster-autoscaler-priority-expander
  namespace: kube-system
  labels:
    app: cluster-autoscaler
data:
  priorities: |-
    # Priority configuration for node group selection
    # Higher numbers = higher priority

    # Prefer spot instances for cost optimization
    50:
    - .*-spot-.*

    # Prefer compute-optimized nodes for Minecraft servers
    40:
    - .*minecraft-servers.*

    # General purpose nodes as fallback
    30:
    - .*general.*

    # Database nodes for specific workloads
    20:
    - .*database.*

    # GPU nodes lowest priority (expensive)
    10:
    - .*gpu.*

---
# Custom metrics for cluster autoscaler
apiVersion: v1
kind: ConfigMap
metadata:
  name: cluster-autoscaler-custom-metrics
  namespace: kube-system
data:
  custom-metrics.yaml: |
    # Custom metrics for intelligent cluster scaling
    customMetrics:
      # Minecraft-specific metrics
      minecraft:
        - name: "pending_players_per_node"
          description: "Number of players waiting to join servers per node"
          query: "sum(minecraft_pending_players) by (node)"
          scaleUpThreshold: 20
          scaleDownThreshold: 5

        - name: "server_density_per_node"
          description: "Number of Minecraft servers per node"
          query: "count(minecraft_server_active{node=~\".+\"}) by (node)"
          scaleUpThreshold: 10
          scaleDownThreshold: 3

      # Resource-based metrics
      resources:
        - name: "cpu_pressure_per_node"
          description: "CPU pressure per node"
          query: "avg(node_cpu_utilization) by (node)"
          scaleUpThreshold: 0.8
          scaleDownThreshold: 0.3

        - name: "memory_pressure_per_node"
          description: "Memory pressure per node"
          query: "avg(node_memory_utilization) by (node)"
          scaleUpThreshold: 0.85
          scaleDownThreshold: 0.4

        - name: "disk_pressure_per_node"
          description: "Disk pressure per node"
          query: "avg(node_disk_utilization) by (node)"
          scaleUpThreshold: 0.9
          scaleDownThreshold: 0.5

      # Cost optimization metrics
      cost:
        - name: "cost_per_player_hour"
          description: "Infrastructure cost per player hour"
          query: "sum(node_cost_per_hour) / sum(minecraft_active_players)"
          optimizationTarget: "minimize"

        - name: "spot_instance_interruption_rate"
          description: "Rate of spot instance interruptions"
          query: "rate(spot_instance_interruptions[1h])"
          threshold: 0.1  # 10% per hour

---
# Node termination handler for graceful spot instance handling
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: aws-node-termination-handler
  namespace: kube-system
spec:
  selector:
    matchLabels:
      app: aws-node-termination-handler
  template:
    metadata:
      labels:
        app: aws-node-termination-handler
    spec:
      serviceAccountName: aws-node-termination-handler
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      containers:
      - name: aws-node-termination-handler
        image: public.ecr.aws/aws-ec2/aws-node-termination-handler:v1.17.2
        env:
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: SPOT_INSTANCE_TERMINATING_ENDPOINT_ENABLE
          value: "true"
        - name: SCHEDULED_EVENT_ENDPOINT_ENABLE
          value: "true"
        - name: INSTANCE_METADATA_ENDPOINT_ENABLE
          value: "true"
        - name: ENABLE_PROMETHEUS_SERVER
          value: "true"
        - name: PROMETHEUS_SERVER_PORT
          value: "9092"
        # Minecraft-specific configuration
        - name: COMPLETE_LIFECYCLE_ACTION_DELAY_SECONDS
          value: "300"  # 5 minutes to complete Minecraft server shutdown
        - name: ENABLE_SCHEDULED_EVENT_DRAINING
          value: "true"
        - name: METADATA_TRIES
          value: "3"
        - name: DRY_RUN
          value: "false"
        - name: CORDON_ONLY
          value: "false"
        - name: TAINT_NODE
          value: "true"
        - name: JSON_LOGGING
          value: "true"
        - name: LOG_LEVEL
          value: "info"
        - name: WEBHOOK_URL
          value: "http://minecraft-server-lifecycle-webhook.minecraft-platform.svc.cluster.local:8080/node-termination"
        ports:
        - containerPort: 9092
          name: http-metrics
          protocol: TCP
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
        resources:
          limits:
            cpu: 100m
            memory: 128Mi
          requests:
            cpu: 50m
            memory: 64Mi
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 1000
      tolerations:
      - operator: Exists
      nodeSelector:
        kubernetes.io/os: linux

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: aws-node-termination-handler
  namespace: kube-system

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: aws-node-termination-handler
rules:
- apiGroups: [""]
  resources: ["nodes"]
  verbs: ["get", "list", "patch", "update"]
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["list", "get"]
- apiGroups: [""]
  resources: ["pods/eviction"]
  verbs: ["create"]
- apiGroups: ["extensions", "apps"]
  resources: ["daemonsets"]
  verbs: ["get"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: aws-node-termination-handler
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: aws-node-termination-handler
subjects:
- kind: ServiceAccount
  name: aws-node-termination-handler
  namespace: kube-system