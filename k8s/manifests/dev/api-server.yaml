---
# API Server deployment for local development
apiVersion: v1
kind: ConfigMap
metadata:
  name: api-server-config
  namespace: minecraft-system
data:
  DATABASE_HOST: "cockroachdb.minecraft-system.svc.cluster.local"
  DATABASE_PORT: "26257"
  DATABASE_NAME: "minecraft_platform"
  DATABASE_USER: "minecraft"
  DATABASE_SSLMODE: "disable"
  REDIS_HOST: "redis.minecraft-system.svc.cluster.local"
  REDIS_PORT: "6379"
  SERVER_PORT: "8080"
  LOG_LEVEL: "debug"
  ENVIRONMENT: "development"
  KUBERNETES_NAMESPACE: "minecraft-servers"
---
apiVersion: v1
kind: Secret
metadata:
  name: api-server-secrets
  namespace: minecraft-system
type: Opaque
stringData:
  DATABASE_PASSWORD: "minecraft_dev"
  JWT_SECRET: "dev-jwt-secret-change-in-production"
---
apiVersion: v1
kind: Service
metadata:
  name: api-server
  namespace: minecraft-system
  labels:
    app: api-server
spec:
  ports:
    - name: http
      port: 8080
      targetPort: 8080
  selector:
    app: api-server
  type: ClusterIP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-server
  namespace: minecraft-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: api-server
  template:
    metadata:
      labels:
        app: api-server
    spec:
      serviceAccountName: api-server
      containers:
        - name: api-server
          image: minecraft-platform-api:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8080
          envFrom:
            - configMapRef:
                name: api-server-config
            - secretRef:
                name: api-server-secrets
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 15
            periodSeconds: 20
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 10
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: api-server
  namespace: minecraft-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: api-server-role
rules:
  # MinecraftServer CRD permissions
  - apiGroups:
      - minecraft.platform.com
    resources:
      - minecraftservers
    verbs:
      - create
      - delete
      - get
      - list
      - patch
      - update
      - watch
  - apiGroups:
      - minecraft.platform.com
    resources:
      - minecraftservers/status
    verbs:
      - get
  # Pod logs for server logs endpoint
  - apiGroups:
      - ""
    resources:
      - pods
      - pods/log
    verbs:
      - get
      - list
      - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: api-server-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: api-server-role
subjects:
  - kind: ServiceAccount
    name: api-server
    namespace: minecraft-system
